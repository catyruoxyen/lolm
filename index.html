<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wild Rift BP Board</title>

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#111827;
      --line:#243042;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --we:#8ab4ff33;
      --vs:#ff8aa033;
      --btn:#2563eb;
      --btn2:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;background:var(--bg);color:var(--text);}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(180deg, rgba(11,15,22,.95), rgba(11,15,22,.75));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:14px 16px;}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;}
    .title{font-weight:900;letter-spacing:.4px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      border:0;color:white;padding:10px 12px;border-radius:10px;
      background:var(--btn);cursor:pointer;font-weight:800;
    }
    button.secondary{background:var(--btn2)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .layout{display:grid;grid-template-columns: 1fr 520px;gap:14px;align-items:start;}
    @media (max-width: 1100px){.layout{grid-template-columns:1fr}}

    .left{display:flex;flex-direction:column;gap:14px;}
    .board{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.95), rgba(15,23,42,.95));
      border-radius:14px;overflow:hidden;
    }
    .boardHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;border-bottom:1px solid var(--line);
    }
    .boardHead .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px;}
    .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(36,48,66,.9);}

    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    th, td{border-bottom:1px solid rgba(36,48,66,.6);padding:10px 10px;vertical-align:middle;}
    th{color:var(--muted);font-size:13px;font-weight:800}
    th.we, td.we{background:var(--we)}
    th.vs, td.vs{background:var(--vs)}
    th.phase, td.phase{background:rgba(255,255,255,.04);text-align:center;width:80px}
    .slot{display:flex;gap:10px;align-items:center;}
    .slot select{
      width:100%;
      background:#0b1220;color:var(--text);
      border:1px solid var(--line);border-radius:10px;
      padding:9px 10px;outline:none;
    }
    .mini{width:34px;height:34px;border-radius:8px;object-fit:cover;border:1px solid var(--line);background:#0b1220;}

    .hint{color:var(--muted);font-size:12px;padding:10px 12px;}

    /* RIGHT: tier wall like your screenshot */
    .right{
      position:sticky;top:70px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.95), rgba(15,23,42,.95));
      border-radius:14px;overflow:hidden;
      max-height: calc(100vh - 86px);
      display:flex;flex-direction:column;
    }
    .rightHead{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .count{color:var(--muted);font-size:13px;font-weight:700}
    .search{
      width:220px;
      background:#0b1220;color:var(--text);
      border:1px solid var(--line);border-radius:10px;
      padding:9px 10px;outline:none;
    }
    .tierWall{overflow:auto;padding:10px 10px 14px 10px;display:flex;flex-direction:column;gap:10px;}

    .tierRow{
      display:grid;
      grid-template-columns: 72px 1fr;
      gap:10px;
      align-items:stretch;
    }
    .tierLabel{
      border-radius:10px;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;
      color:#0b0f16;
      letter-spacing:.5px;
      user-select:none;
    }
    .tierStrip{
      border-radius:10px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(36,48,66,.65);
      padding:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-height:56px;
    }
    .champTile{
      width:46px;height:46px;border-radius:10px;
      border:1px solid rgba(36,48,66,.8);
      background:#0b1220;
      overflow:hidden;
      position:relative;
    }
    .champTile img{width:100%;height:100%;object-fit:cover;display:block;}
    .champTile:hover{outline:2px solid rgba(255,255,255,.18)}
    .champTile .tip{
      position:absolute;left:6px;bottom:6px;
      font-size:11px;font-weight:900;
      padding:2px 6px;border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      max-width: calc(100% - 12px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    /* Tom Select: dark theme tweaks */
    .ts-wrapper{width:100%;}
    .ts-control{
      background:#0b1220 !important;
      color:var(--text) !important;
      border:1px solid var(--line) !important;
      border-radius:10px !important;
      padding:6px 10px !important;
      min-height:40px !important;
      box-shadow:none !important;
    }
    .ts-control input{color:var(--text) !important;}
    .ts-control .item{color:var(--text) !important;}
    .ts-dropdown{
      background:#0b1220 !important;
      border:1px solid var(--line) !important;
      border-radius:12px !important;
      overflow:hidden;
      z-index:9999;
    }
    .ts-dropdown .option{color:var(--text) !important;}
    .ts-dropdown .option.active{background:rgba(255,255,255,.08) !important;}
    .ts-dropdown .option.selected{background:rgba(37,99,235,.25) !important;}
  </style>

  <!-- Searchable selects (type-to-search) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div class="title">Wild Rift 全局 BP 面板</div>
    <div class="actions">
      <button id="addBoardBtn" class="secondary" type="button">新增BP表格</button>
      <button id="resetBtn" type="button">重置全部</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <section class="left" id="boards"></section>

    <aside class="right">
      <div class="rightHead">
        <div style="font-weight:900">角色優先級（Tier）</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input class="search" id="searchInput" placeholder="搜尋英雄 / 路線" />
          <div class="count" id="availableCount">-</div>
        </div>
      </div>
      <div class="tierWall" id="tierWall"></div>
    </aside>
  </div>
</main>

<script>
/** BP 順序 */
const PHASES = [
  { key:"1B", type:"ban" },
  { key:"2B", type:"ban" },
  { key:"3B", type:"ban" },
  { key:"1P", type:"pick" },
  { key:"2P", type:"pick" },
  { key:"3P", type:"pick" },
  { key:"4B", type:"ban" },
  { key:"5B", type:"ban" },
  { key:"4P", type:"pick" },
  { key:"5P", type:"pick" }
];

const STORAGE_KEY = "wr_bp_state_v3";
const TIER_ORDER = ["T0","T1","T2","T3","T4","T5"];

const TIER_COLOR = {
  T0:"#ff6b6b",
  T1:"#ffb86b",
  T2:"#ffe26b",
  T3:"#c8f26b",
  T4:"#6bf2a7",
  T5:"#a7b0c0"
};

let champions = [];
let champById = new Map();
let boards = [];
let searchTerm = "";

/** Tom Select instances (because we re-render DOM often) */
let tomInstances = new Map();

/* ---------- init ---------- */
(async function init(){
  bindUI();            // 先綁 UI，避免資料載入失敗時按鈕沒反應
  await loadData();    // 再載入角色資料
  loadStateOrDefault();
  renderAll();
})();

/* ---------- data loading ---------- */
async function loadData(){
  // 1) try champions.json
  try{
    const r = await fetch("./champions.json", { cache:"no-store" });
    if(r.ok){
      const arr = await r.json();
      setChampions(arr);
      return;
    }
  }catch(e){}

  // 2) fallback: 角色清單.txt（用你現在這份格式）
  try{
    const r2 = await fetch("./角色清單.txt", { cache:"no-store" });
    if(!r2.ok) throw new Error("no file");
    const text = await r2.text();
    const arr2 = parseRoleListText(text);
    setChampions(arr2);
    return;
  }catch(e){
    alert("找不到 champions.json 或 角色清單.txt，請先把其中一個放在 repo 根目錄。");
    setChampions([]);
  }
}

function setChampions(arr){
  champions = (arr || [])
    .filter(x => x && x.id && x.name)
    .map(x => ({
      id: String(x.id),
      name: String(x.name),
      image: x.image ? String(x.image) : "",
      priority: x.priority ? String(x.priority) : "T3",
      positions: Array.isArray(x.positions) ? x.positions.map(String) : []
    }));
  champById = new Map(champions.map(c => [c.id, c]));
}

function parseRoleListText(text){
  const lines = text
    .split(/\r?\n/g)
    .map(s => s.replace(/\uFEFF/g,"").trim())
    .filter(s => s.length > 0);

  const out = [];
  let startIdx = lines.findIndex(l => l.includes("角色名稱"));
  if(startIdx === -1) startIdx = 0;

  let i = startIdx;
  while(i < lines.length-1){
    if(/^https?:\/\//i.test(lines[i+1])) break;
    i++;
  }

  while(i + 3 < lines.length){
    const name = lines[i];
    const image = lines[i+1];
    const tier = lines[i+2];
    const lanes = lines[i+3];

    if(!name || !/^https?:\/\//i.test(image) || !/^T\d$/i.test(tier)){
      i++;
      continue;
    }

    const positions = lanes
      .split(/[、,\/\s]+/g)
      .map(s => s.trim())
      .filter(Boolean);

    out.push({
      id: slugify(name),
      name,
      image,
      priority: tier.toUpperCase(),
      positions
    });

    i += 4;
  }

  const seen = new Set();
  return out.filter(c => (seen.has(c.id) ? false : (seen.add(c.id), true)));
}

function slugify(name){
  return encodeURIComponent(name);
}

/* ---------- state ---------- */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function defaultBoard(){
  const id = uid();
  const slots = {};
  for(const p of PHASES) slots[p.key] = { we:null, vs:null };
  return { id, slots };
}

function loadStateOrDefault(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      const parsed = JSON.parse(raw);
      if(parsed && Array.isArray(parsed.boards) && parsed.boards.length){
        boards = parsed.boards;
        return;
      }
    }catch(e){}
  }
  boards = [defaultBoard(), defaultBoard(), defaultBoard()];
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ boards }));
}

function getGlobalUsedSet(){
  const used = new Set();
  for(const b of boards){
    for(const k in b.slots){
      const s = b.slots[k];
      if(s.we) used.add(s.we);
      if(s.vs) used.add(s.vs);
    }
  }
  return used;
}

/* ---------- render ---------- */
function renderAll(){
  renderBoards();
  renderTierWall();
}

function renderBoards(){
  const container = document.getElementById("boards");
  container.innerHTML = "";
  const used = getGlobalUsedSet();

  boards.forEach((board, idx) => {
    const el = document.createElement("div");
    el.className = "board";
    el.innerHTML = `
      <div class="boardHead">
        <div style="font-weight:900">第 ${idx+1} 局 BP</div>
        <div class="meta">
          <span class="badge">全局已用：${used.size}</span>
          <button class="secondary" type="button" data-del="${board.id}" style="padding:8px 10px;border-radius:10px">刪除此表</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th class="we"></th>
            <th class="phase">vs</th>
            <th class="vs"></th>
          </tr>
        </thead>
        <tbody>
          ${PHASES.map(p => {
            const row = board.slots[p.key];
            return `
              <tr>
                <td class="we">${slotHTML(board.id, p.key, "we", row.we, used)}</td>
                <td class="phase">${p.key}</td>
                <td class="vs">${slotHTML(board.id, p.key, "vs", row.vs, used)}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
      <div class="hint">提示：每一格下拉都支援「打字搜尋」；任一格選到/禁到英雄會全局移除右側 Tier 清單。</div>
    `;
    container.appendChild(el);
  });

  // delete board
  container.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del");
      if(boards.length <= 1){
        alert("至少保留 1 張 BP 表。");
        return;
      }
      boards = boards.filter(b => b.id !== id);
      saveState();
      renderAll();
    });
  });

  // slot change
  container.querySelectorAll("select[data-slot]").forEach(sel => {
    sel.addEventListener("change", () => {
      const boardId = sel.dataset.board;
      const phaseKey = sel.dataset.phase;
      const side = sel.dataset.side;
      const newId = sel.value || null;

      const board = boards.find(b => b.id === boardId);
      board.slots[phaseKey][side] = newId;

      saveState();
      renderAll();
    });
  });

  // make selects searchable
  initSearchableSelects();
}

function slotHTML(boardId, phaseKey, side, selectedId, usedSet){
  const champ = selectedId ? champById.get(selectedId) : null;
  const options = buildOptions(selectedId, usedSet);

  const img = champ?.image
    ? `<img class="mini" src="${esc(champ.image)}" alt="" loading="lazy">`
    : `<div class="mini"></div>`;

  return `
    <div class="slot">
      ${img}
      <div style="width:100%">
        <select class="champSelect" data-slot="1" data-board="${boardId}" data-phase="${phaseKey}" data-side="${side}">
          ${options}
        </select>
      </div>
    </div>
  `;
}

function buildOptions(selectedId, usedSet){
  const term = (searchTerm || "").trim().toLowerCase();

  const filtered = champions.filter(c => {
    if(c.id !== selectedId && usedSet.has(c.id)) return false;

    // 右側搜尋框（全域過濾）；每個下拉自己的打字搜尋由 TomSelect 處理
    if(!term) return true;

    const txt = (c.name + " " + (c.positions||[]).join(" ") + " " + (c.priority||"")).toLowerCase();
    return txt.includes(term);
  });

  filtered.sort((a,b) => {
    const pa = TIER_ORDER.indexOf(a.priority);
    const pb = TIER_ORDER.indexOf(b.priority);
    const ra = pa === -1 ? 999 : pa;
    const rb = pb === -1 ? 999 : pb;
    if(ra !== rb) return ra - rb;
    return (a.name || "").localeCompare(b.name || "", "zh-Hant");
  });

  const opts = [
    `<option value="">（空）</option>`,
    ...filtered.map(c => `<option value="${esc(c.id)}" ${c.id===selectedId?"selected":""}>[${esc(c.priority||"-")}] ${esc(c.name)}</option>`)
  ];

  if(selectedId && !filtered.some(c => c.id === selectedId)){
    const c = champById.get(selectedId);
    if(c){
      opts.splice(1, 0, `<option value="${esc(c.id)}" selected>（已選）[${esc(c.priority||"-")}] ${esc(c.name)}</option>`);
    }
  }
  return opts.join("");
}

function renderTierWall(){
  const used = getGlobalUsedSet();

  const available = champions.filter(c => !used.has(c.id));
  document.getElementById("availableCount").textContent = `可用：${available.length} / ${champions.length}`;

  const term = (searchTerm || "").trim().toLowerCase();
  const shown = !term ? available : available.filter(c => {
    const txt = (c.name + " " + (c.positions||[]).join(" ") + " " + (c.priority||"")).toLowerCase();
    return txt.includes(term);
  });

  const groups = new Map();
  for(const c of shown){
    const t = c.priority || "T3";
    if(!groups.has(t)) groups.set(t, []);
    groups.get(t).push(c);
  }

  const tiers = Array.from(new Set([...TIER_ORDER, ...groups.keys()]))
    .filter(t => groups.has(t));

  const wall = document.getElementById("tierWall");
  wall.innerHTML = tiers.map(t => {
    const arr = groups.get(t) || [];
    arr.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "zh-Hant"));

    const color = TIER_COLOR[t] || "#a7b0c0";
    return `
      <div class="tierRow">
        <div class="tierLabel" style="background:${color}">${esc(t)}</div>
        <div class="tierStrip">
          ${arr.map(c => `
            <div class="champTile" title="${esc(c.name)}（${esc((c.positions||[]).join(" / "))}）">
              <img src="${esc(c.image||"")}" alt="${esc(c.name)}" loading="lazy">
              <div class="tip">${esc(c.name)}</div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  }).join("") || `<div style="color:var(--muted);padding:6px 2px">沒有符合的英雄（可能都被選/禁了，或搜尋條件太嚴格）。</div>`;
}

/* ---------- type-to-search for each select ---------- */
function initSearchableSelects(){
  if(typeof TomSelect === "undefined") return;

  // destroy old instances (we re-render DOM often)
  for(const inst of tomInstances.values()){
    try{ inst.destroy(); }catch(e){}
  }
  tomInstances.clear();

  document.querySelectorAll("select.champSelect").forEach(sel => {
    const inst = new TomSelect(sel, {
      create: false,
      maxItems: 1,
      allowEmptyOption: true,
      openOnFocus: true,
      searchField: ["text"],
      placeholder: "輸入英雄名稱搜尋…",
      dropdownParent: "body"
    });
    tomInstances.set(sel, inst);
  });
}

/* ---------- UI ---------- */
function bindUI(){
  document.getElementById("addBoardBtn").addEventListener("click", () => {
    boards.push(defaultBoard());
    saveState();
    renderAll();
    requestAnimationFrame(()=> window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" }));
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if(!confirm("確定要重置全部？會清空所有 BP 表並恢復右側清單。")) return;
    localStorage.removeItem(STORAGE_KEY);
    boards = [defaultBoard(), defaultBoard(), defaultBoard()];
    saveState();
    renderAll();
  });

  document.getElementById("searchInput").addEventListener("input", (e) => {
    searchTerm = e.target.value || "";
    renderAll();
  });
}

/* ---------- util ---------- */
function esc(s){
  return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
</script>
</body>
</html>
